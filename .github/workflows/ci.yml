name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # ç¯å¢ƒéªŒè¯
  environment-validation:
    name: Environment Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate environment files
        run: |
          echo "éªŒè¯ç¯å¢ƒé…ç½®æ–‡ä»¶..."
          pnpm env:validate

          # æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
          if [ -f ".env.example" ]; then
            echo "ç¯å¢ƒå˜é‡æ¨¡æ¿æ£€æŸ¥é€šè¿‡"
          else
            echo "è­¦å‘Š: ç¼ºå°‘ .env.example æ–‡ä»¶"
          fi

      - name: Check environment consistency
        run: |
          echo "æ£€æŸ¥ç¯å¢ƒé…ç½®ä¸€è‡´æ€§..."
          pnpm env:check

  # ä»£ç è´¨é‡æ£€æŸ¥
  lint-and-format:
    name: Lint & Format
    runs-on: ubuntu-latest
    needs: environment-validation

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linting
        run: pnpm lint

      - name: Check formatting
        run: pnpm format:check || echo "Format check failed, but continuing..."

      - name: Type check
        run: pnpm type-check

  # ç±»å‹ç”Ÿæˆå’ŒéªŒè¯
  type-generation:
    name: Type Generation
    runs-on: ubuntu-latest
    needs: lint-and-format

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate types
        run: pnpm generate:types

      - name: Check if types are up to date
        run: |
          if [ -n "$(git status --porcelain packages/types/src/generated/)" ]; then
            echo "Generated types are not up to date"
            git diff packages/types/src/generated/
            exit 1
          fi

      - name: Validate generated types
        run: pnpm type-check

  # æµ‹è¯•
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: type-generation

    strategy:
      matrix:
        node-version: [16, 18, 20]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: matrix.node-version == '18'
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # æ„å»º
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Performance monitoring
        run: |
          echo "å¼€å§‹æ€§èƒ½ç›‘æ§..."

          # è®°å½•æ„å»ºæ—¶é—´
          echo "æ„å»ºå¼€å§‹æ—¶é—´: $(date)"
          START_TIME=$(date +%s)

          # æ‰§è¡Œæ„å»º
          pnpm build

          # è®°å½•æ„å»ºç»“æŸæ—¶é—´
          END_TIME=$(date +%s)
          BUILD_DURATION=$((END_TIME - START_TIME))

          echo "æ„å»ºç»“æŸæ—¶é—´: $(date)"
          echo "æ„å»ºè€—æ—¶: ${BUILD_DURATION} ç§’"

          # æ£€æŸ¥æ„å»ºæ—¶é—´æ˜¯å¦è¶…è¿‡é˜ˆå€¼
          if [ $BUILD_DURATION -gt 300 ]; then
            echo "è­¦å‘Š: æ„å»ºæ—¶é—´è¶…è¿‡5åˆ†é’Ÿ"
          fi

          # åˆ†æåŒ…å¤§å°
          echo "åˆ†æåŒ…å¤§å°..."
          for pkg in packages/*/dist/; do
            if [ -d "$pkg" ]; then
              SIZE=$(du -sh "$pkg" | cut -f1)
              echo "åŒ…å¤§å°: $pkg = $SIZE"
            fi
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            packages/*/dist/
            packages/*/coverage/

  # å®‰å…¨æ‰«æ
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: |
          echo "æ‰§è¡Œå®‰å…¨å®¡è®¡..."
          pnpm audit --audit-level moderate

          # æ£€æŸ¥å·²çŸ¥æ¼æ´
          if [ $? -ne 0 ]; then
            echo "å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·æ£€æŸ¥å¹¶ä¿®å¤"
            exit 1
          fi

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: .
          base: ${{ github.event.before }}
          head: ${{ github.event.after }}

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  # æ–‡æ¡£ç”Ÿæˆ
  docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate documentation
        run: pnpm docs

      - name: Upload documentation
        uses: actions/upload-artifact@v3
        with:
          name: documentation
          path: docs/

  # å‘å¸ƒåˆ° npm (ä»… main åˆ†æ”¯)
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [build, docs]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Backup current versions
        id: backup-versions
        run: |
          echo "å¤‡ä»½å½“å‰ç‰ˆæœ¬ä¿¡æ¯..."
          for pkg in packages/*/package.json; do
            if [ -f "$pkg" ]; then
              pkg_name=$(jq -r '.name' "$pkg")
              pkg_version=$(jq -r '.version' "$pkg")
              echo "::set-output name=${pkg_name//\//_}_version::$pkg_version"
              echo "å¤‡ä»½: $pkg_name@$pkg_version"
            fi
          done

      - name: Publish packages
        id: publish
        run: |
          echo "å¼€å§‹å‘å¸ƒåŒ…..."
          pnpm publish --recursive --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

      - name: Check publish status
        id: check-publish
        run: |
          if [ "${{ steps.publish.outcome }}" == "success" ]; then
            echo "å‘å¸ƒæˆåŠŸ"
            echo "::set-output name=success::true"
          else
            echo "å‘å¸ƒå¤±è´¥ï¼Œå‡†å¤‡å›æ»š"
            echo "::set-output name=success::false"
          fi

      - name: Rollback on failure
        if: steps.check-publish.outputs.success == 'false'
        run: |
          echo "æ‰§è¡Œå›æ»šæ“ä½œ..."

          # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬
          PREVIOUS_COMMIT=$(git rev-parse HEAD~1)

          # å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
          git reset --hard $PREVIOUS_COMMIT

          # æ›´æ–°ç‰ˆæœ¬å·
          for pkg in packages/*/package.json; do
            if [ -f "$pkg" ]; then
              pkg_name=$(jq -r '.name' "$pkg")
              echo "å›æ»š $pkg_name ç‰ˆæœ¬"
              # è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„å›æ»šé€»è¾‘
            fi
          done

          echo "å›æ»šå®Œæˆ"

      - name: Notify on failure
        if: steps.check-publish.outputs.success == 'false'
        run: |
          echo "å‘å¸ƒå¤±è´¥ï¼Œå‘é€é€šçŸ¥"
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œå¦‚å‘é€åˆ° Slack æˆ–é‚®ä»¶
          echo "å‘å¸ƒå¤±è´¥: ${{ github.repository }}@${{ github.sha }}"

  # éƒ¨ç½²åˆ° GitHub Pages (ä»… main åˆ†æ”¯)
  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: docs
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate documentation
        run: pnpm docs

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          force_orphan: true

  # é€šçŸ¥æœºåˆ¶
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [publish, deploy-docs]
    if: always()

    steps:
      - name: Notify on success
        if: needs.publish.result == 'success' && needs.deploy-docs.result == 'success'
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
          echo "é¡¹ç›®: ${{ github.repository }}"
          echo "åˆ†æ”¯: ${{ github.ref }}"
          echo "æäº¤: ${{ github.sha }}"
          echo "æ—¶é—´: $(date)"

          # è¿™é‡Œå¯ä»¥æ·»åŠ  Slackã€Discord æˆ–å…¶ä»–é€šçŸ¥æ¸ é“
          # ä¾‹å¦‚: curl -X POST -H 'Content-type: application/json' --data '{"text":"éƒ¨ç½²æˆåŠŸ!"}' $SLACK_WEBHOOK_URL

      - name: Notify on failure
        if: needs.publish.result == 'failure' || needs.deploy-docs.result == 'failure'
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥!"
          echo "é¡¹ç›®: ${{ github.repository }}"
          echo "åˆ†æ”¯: ${{ github.ref }}"
          echo "æäº¤: ${{ github.sha }}"
          echo "æ—¶é—´: $(date)"
          echo "å¤±è´¥ä½œä¸š:"
          echo "- Publish: ${{ needs.publish.result }}"
          echo "- Deploy: ${{ needs.deploy-docs.result }}"

          # è¿™é‡Œå¯ä»¥æ·»åŠ å¤±è´¥é€šçŸ¥é€»è¾‘
          # ä¾‹å¦‚: curl -X POST -H 'Content-type: application/json' --data '{"text":"éƒ¨ç½²å¤±è´¥!"}' $SLACK_WEBHOOK_URL
