# IMTP 项目脚本详细说明文档

## 📋 目录

[toc]

## 📖 概述

IMTP 项目包含了一套完整的开发工具链脚本，涵盖了从环境管理、类型生成、构建测试到监控备份的全流程。这些脚本采用模块化设计，支持独立运行和组合使用。

### 🎯 脚本设计原则

- **模块化**: 每个脚本专注于特定功能
- **容错性**: 支持优雅的错误处理和降级方案
- **可配置**: 通过环境变量和配置文件灵活配置
- **可扩展**: 易于添加新功能和自定义
- **交互式**: 提供统一的交互式管理界面

## 📂 脚本分类

### 按功能分类

| 类别     | 脚本数量 | 主要功能                         | 状态      |
| -------- | -------- | -------------------------------- | --------- |
| 核心开发 | 3        | 项目分析、开发工具、包创建       | ✅ 已完成 |
| 环境管理 | 4        | 环境变量检查、验证、创建         | ✅ 已完成 |
| 类型生成 | 3        | TypeScript、API、GraphQL类型生成 | ✅ 已完成 |
| 构建测试 | 6        | 构建、测试、清理、格式化         | ✅ 已完成 |
| 代码质量 | 3        | Lint、类型检查、预提交           | ✅ 已完成 |
| 监控备份 | 2        | 性能监控、备份回滚               | ✅ 已完成 |
| 工具脚本 | 4        | 最小化构建、验证等               | ✅ 已完成 |
| 交互式   | 1        | 统一的交互式脚本管理器           | ✅ 已完成 |

### 按使用频率分类

- **高频使用**: 交互式工具、构建、测试、格式化、环境管理
- **中频使用**: 类型生成、代码质量检查
- **低频使用**: 监控、备份、分析

## 🎯 交互式脚本管理器

### `interactive.js` - 统一交互式管理器 ✅ 已实现

**功能**: 提供统一的交互式界面，整合所有功能模块，大幅简化package.json脚本

**使用方法**:

```bash
# 启动交互式管理器
pnpm interactive
```

**功能模块**:

```
🚀 IMTP 交互式脚本管理器
==================================================
请选择要执行的功能：

1. 📦 依赖管理 (7个选项)
2. 🔧 环境管理 (5个选项)
3. 💾 备份管理 (4个选项)
4. 📊 监控管理 (5个选项)
5. 🛠️  开发工具 (7个选项)
6. 📋 生成工具 (5个选项)
7. 🧪 测试工具 (4个选项)
8. 🏗️  构建工具 (4个选项)
9. 🔒 安全工具 (2个选项)
0. ❌ 退出
```

**优化效果**:

- **package.json脚本数量**: 从35个减少到11个 (减少68%)
- **命令记忆**: 只需要记住一个命令 `pnpm interactive`
- **用户体验**: 清晰的菜单和选项，带emoji图标
- **操作效率**: 循环操作，执行后自动返回菜单

## 🔧 核心开发脚本

### 1. `dev-tools.js` - 开发工具集 ✅ 已实现

**功能**: 提供统一的开发工具入口，集成多种开发功能

**使用方法**:

```bash
# 基本用法
node scripts/dev-tools.js <command> [sub-command]

# 项目分析
node scripts/dev-tools.js analyze

# 代码质量检查
node scripts/dev-tools.js lint

# 类型检查
node scripts/dev-tools.js type-check

# 环境变量管理
node scripts/dev-tools.js env:check
node scripts/dev-tools.js env:validate
node scripts/dev-tools.js env:create
node scripts/dev-tools.js env:local
node scripts/dev-tools.js env:list
```

**功能详解**:

#### 项目分析 (`analyze`)

- 分析包大小和依赖关系
- 测量构建时间
- 检查代码质量指标
- 生成性能报告

#### 代码质量检查 (`lint`)

- 运行 ESLint 检查
- 统计错误和警告数量
- 生成详细报告
- 支持自动修复

#### 类型检查 (`type-check`)

- 运行 TypeScript 类型检查
- 检查所有包的类型定义
- 生成类型错误报告

#### 环境变量管理 (`env:*`)

- `env:check`: 显示当前环境变量
- `env:validate`: 验证环境变量完整性
- `env:create`: 创建环境文件模板
- `env:local`: 创建本地环境文件
- `env:list`: 列出所有环境文件

**配置选项**:

- 通过环境变量配置检查规则
- 支持自定义忽略文件
- 可配置超时时间

### 2. `create-package.js` - 包创建工具 ✅ 已实现

**功能**: 快速创建新的 npm 包，自动生成标准目录结构和配置文件

**使用方法**:

```bash
node scripts/create-package.js <package-name>
```

**示例**:

```bash
node scripts/create-package.js my-utility
```

**生成的文件结构**:

```
packages/my-utility/
├── package.json          # 包配置文件
├── tsconfig.json         # TypeScript配置
├── vite.config.ts        # Vite构建配置
├── vitest.config.ts      # 测试配置
├── src/
│   └── index.ts          # 主入口文件
└── tests/
    └── index.test.ts     # 测试文件
```

**自动配置内容**:

- 包名格式: `@imtp/<package-name>`
- 标准脚本: build, test, lint, clean
- 开发依赖: TypeScript, Vite, Vitest
- 发布配置: public access

**验证规则**:

- 包名只能包含小写字母、数字和连字符
- 必须以字母开头
- 检查包名是否已存在

### 3. `dependency-manager.js` - 依赖管理工具 ✅ 已实现

**功能**: 智能管理项目依赖，包括更新、冲突检测、安全扫描

**使用方法**:

```bash
# 检查依赖更新
node scripts/dependency-manager.js updates

# 检测依赖冲突
node scripts/dependency-manager.js conflicts

# 安全扫描
node scripts/dependency-manager.js security

# 清理无用依赖
node scripts/dependency-manager.js cleanup
```

## 🌍 环境管理脚本

### 1. `env-manager.js` - 环境变量管理器 ✅ 已实现

**功能**: 统一管理项目环境变量，支持多环境配置

**使用方法**:

```bash
# 检查环境变量
node scripts/env-manager.js check

# 验证环境变量
node scripts/env-manager.js validate

# 创建环境文件
node scripts/env-manager.js create [type]

# 列出环境文件
node scripts/env-manager.js list
```

**支持的环境类型**:

- `development` - 开发环境
- `production` - 生产环境
- `test` - 测试环境
- `local` - 本地环境

**环境文件优先级**:

1. `.env.local` (最高优先级)
2. `.env.[mode].local`
3. `.env.[mode]`
4. `.env` (最低优先级)

### 2. `validate-env.js` - 环境变量验证器 ✅ 已实现

**功能**: 验证环境变量的完整性和正确性

**使用方法**:

```bash
node scripts/validate-env.js
```

**验证内容**:

- 必需环境变量检查
- 环境变量类型验证
- 环境变量格式验证
- 敏感信息检查

**必需环境变量**:

- `DATABASE_URL` - 数据库连接字符串
- `JWT_SECRET` - JWT密钥

**可选环境变量**:

- `API_BASE_URL` - API基础地址
- `REDIS_URL` - Redis连接地址
- `SMTP_*` - 邮件服务配置
- `GOOGLE_*` - Google服务配置

### 3. `test-env.js` - 环境测试工具 ✅ 已实现

**功能**: 测试环境配置的正确性和可用性

**使用方法**:

```bash
node scripts/test-env.js
```

**测试内容**:

- 数据库连接测试
- Redis连接测试
- API服务测试
- 邮件服务测试

## 🔤 类型生成脚本

### 1. `generate-types.js` - TypeScript类型生成器 ✅ 已实现

**功能**: 从多种源自动生成 TypeScript 类型定义

**使用方法**:

```bash
node scripts/generate-types.js generate
```

**支持的源类型**:

- **API接口**: Swagger/OpenAPI 文档
- **数据库模型**: Prisma/Sequelize/TypeORM 模式
- **环境变量**: .env 文件
- **配置文件**: JSON 配置文件

**配置选项**:

```javascript
const CONFIG = {
  sources: {
    api: {
      type: 'swagger',
      url: 'http://localhost:3000/api-docs',
      output: 'packages/types/src/api/generated',
    },
    database: {
      type: 'prisma',
      schema: 'prisma/schema.prisma',
      output: 'packages/types/src/database/generated',
    },
    env: {
      type: 'env',
      file: 'env.example',
      output: 'packages/types/src/env/generated',
    },
    config: {
      type: 'json',
      files: ['config/*.json'],
      output: 'packages/types/src/config/generated',
    },
  },
  output: {
    types: true, // 生成类型文件
    docs: true, // 生成文档
    tests: true, // 生成测试
    format: true, // 格式化代码
  },
};
```

**生成的文件结构**:

```
packages/types/src/
├── api/generated/
│   ├── api.ts
│   └── openapi.ts
├── database/generated/
│   └── database.ts
├── env/generated/
│   └── env.ts
└── config/generated/
    └── config.ts
```

### 2. `generate-api.js` - API类型生成器 ✅ 已实现

**功能**: 专门用于从 API 文档生成 TypeScript 类型

**使用方法**:

```bash
node scripts/generate-api.js
```

**特性**:

- 支持 Swagger/OpenAPI 文档
- 自动安装依赖工具
- 容错处理（API服务未运行时生成示例）
- 可配置输出路径

**环境变量配置**:

- `API_BASE_URL` - API基础地址
- `API_DOCS_URL` - API文档地址
- `API_TYPES_OUTPUT` - 输出文件路径

**示例输出**:

```typescript
export interface ApiResponse<T = any> {
  success: boolean;
  data?: T;
  message?: string;
  code?: number;
}

export interface User {
  id: string;
  email: string;
  name: string;
  createdAt: Date;
  updatedAt: Date;
}
```

### 3. `generate:graphql` - GraphQL类型生成器 ✅ 已实现

**功能**: 从 GraphQL schema 生成 TypeScript 类型

**使用方法**:

```bash
pnpm generate:graphql
```

**配置**: 使用 `codegen.yml` 配置文件

## 🏗️ 构建和测试脚本

### 1. 构建脚本 ✅ 已实现

#### `build` - 标准构建

```bash
pnpm build
```

- 构建所有包
- 生成 ESM、CJS、UMD 格式
- 生成类型定义文件

#### `build:min` - 最小化构建

```bash
pnpm build:min
```

- 生成压缩版本
- 使用 Terser 进行代码压缩
- 生成 `.min.js` 文件

#### `build:clean` - 清理构建

```bash
pnpm build:clean
```

- 清理旧的构建文件
- 重新构建所有包

### 2. 测试脚本 ✅ 已实现

#### `test` - 标准测试

```bash
pnpm test
```

- 运行所有包的测试
- 使用 Vitest 测试框架
- 支持 TypeScript

#### `test:ui` - UI测试

```bash
pnpm test:ui
```

- 启动测试UI界面
- 可视化测试结果
- 支持交互式调试

#### `test:coverage` - 覆盖率测试

```bash
pnpm test:coverage
```

- 生成测试覆盖率报告
- 使用 V8 覆盖率工具
- 输出详细覆盖率信息

#### `test:watch` - 监听测试

```bash
pnpm test:watch
```

- 监听文件变化
- 自动重新运行测试
- 提高开发效率

### 3. 清理脚本 ✅ 已实现

#### `clean` - 标准清理

```bash
pnpm clean
```

- 清理所有包的 dist 目录
- 删除构建产物

#### `clean:all` - 完全清理

```bash
pnpm clean:all
```

- 清理根目录和所有包
- 删除所有构建文件

## 🎯 代码质量脚本

### 1. `lint` - 代码检查 ✅ 已实现

```bash
pnpm lint
```

- 运行 ESLint 检查
- 检查代码风格和潜在问题
- 支持 TypeScript 和 Vue

### 2. `lint:fix` - 自动修复 ✅ 已实现

```bash
pnpm lint:fix
```

- 自动修复可修复的问题
- 格式化代码

### 3. `lint:check` - 严格检查 ✅ 已实现

```bash
pnpm lint:check
```

- 零容忍模式
- 任何警告都会导致失败

### 4. `type-check` - 类型检查 ✅ 已实现

```bash
pnpm type-check
```

- 运行 TypeScript 类型检查
- 检查所有类型定义
- 生成类型错误报告

### 5. `pre-commit.js` - 预提交检查 ✅ 已实现

```bash
node scripts/pre-commit.js
```

- Git 预提交钩子
- 运行 lint-staged
- 确保代码质量

## 📊 监控和备份脚本

### 1. `monitor.js` - 性能监控工具 ✅ 已实现

**功能**: 监控项目性能指标，生成分析报告

**使用方法**:

```bash
# 监控构建性能
node scripts/monitor.js build

# 监控测试性能
node scripts/monitor.js test

# 监控安全状态
node scripts/monitor.js security

# 监控所有指标
node scripts/monitor.js all

# 生成报告
node scripts/monitor.js report
```

**监控指标**:

- 构建时间和成功率
- 测试覆盖率和执行时间
- 包大小和依赖分析
- 安全漏洞检查
- 性能趋势分析

**配置选项**:

```javascript
const MONITOR_CONFIG = {
  buildTimeout: 300000, // 构建超时时间
  testTimeout: 60000, // 测试超时时间
  maxPackageSize: 1024 * 1024, // 最大包大小
  logFile: 'monitor-logs.json', // 日志文件
};
```

**输出文件**:

- `monitor-logs.json` - 监控日志
- `monitor-report.json` - 分析报告

### 2. `rollback.js` - 备份回滚工具 ✅ 已实现

**功能**: 创建项目备份，支持版本回滚

**使用方法**:

```bash
# 创建备份
node scripts/rollback.js create

# 列出备份
node scripts/rollback.js list

# 执行回滚
node scripts/rollback.js rollback <backup-name>

# 清理旧备份
node scripts/rollback.js cleanup
```

**备份内容**:

- 包版本信息
- Git 提交信息
- 包依赖关系
- 配置文件

**配置选项**:

```javascript
const ROLLBACK_CONFIG = {
  maxBackups: 5, // 最大备份数量
  backupDir: '.backups', // 备份目录
  npmRegistry: 'https://registry.npmjs.org',
};
```

**备份文件结构**:

```
.backups/
├── backup-2024-01-01T10-00-00-000Z/
│   ├── backup-info.json
│   └── packages/
└── backup-2024-01-02T10-00-00-000Z/
    ├── backup-info.json
    └── packages/
```

## 🛠️ 工具脚本

### 1. `build-min.js` - 最小化构建工具 ✅ 已实现

**功能**: 为构建产物生成压缩版本

**使用方法**:

```bash
node scripts/build-min.js [package-path]
```

**特性**:

- 支持 ESM、CJS、UMD 格式
- 使用 Terser 进行压缩
- 自动生成 `.min.js` 文件
- 支持批量处理

### 2. `update-lint-scripts.js` - Lint脚本更新器 ✅ 已实现

**功能**: 更新包中的 lint 脚本配置

**使用方法**:

```bash
node scripts/update-lint-scripts.js
```

### 3. `cleanup-scripts.js` - 脚本清理工具 ✅ 已实现

**功能**: 清理临时文件和缓存

**使用方法**:

```bash
node scripts/cleanup-scripts.js
```

### 4. `deploy-docs.js` - 文档部署工具 ✅ 已实现

**功能**: 自动化部署文档站点

**使用方法**:

```bash
node scripts/deploy-docs.js
```

## 📚 使用指南

### 开发工作流

#### 新功能开发

```bash
# 1. 启动交互式工具
pnpm interactive

# 2. 选择开发工具 -> 创建新包
# 或者直接使用命令
node scripts/create-package.js <package-name>

# 3. 设置环境
pnpm env:local

# 4. 开发代码
# ... 编写代码 ...

# 5. 运行测试
pnpm test

# 6. 检查代码质量
pnpm lint
pnpm type-check

# 7. 构建
pnpm build
```

#### 类型生成工作流

```bash
# 使用交互式工具
pnpm interactive
# 选择生成工具 -> 生成所有类型

# 或者直接使用命令
pnpm generate:all

# 或者分别生成
pnpm generate:types
pnpm generate:api
pnpm generate:graphql
```

#### 发布工作流

```bash
# 1. 运行所有检查
pnpm lint
pnpm type-check
pnpm test

# 2. 构建
pnpm build

# 3. 创建变更集
pnpm changeset

# 4. 发布
pnpm release
```

### 环境管理

```bash
# 使用交互式工具
pnpm interactive
# 选择环境管理

# 或者直接使用命令
pnpm env:create <environment>
pnpm env:validate
pnpm env:check
```

### 监控和备份

```bash
# 使用交互式工具
pnpm interactive
# 选择监控管理或备份管理

# 或者直接使用命令
node scripts/monitor.js <type>
node scripts/rollback.js create
node scripts/rollback.js list
```

## 🔧 故障排除

### 常见问题

| 问题           | 解决方案                         |
| -------------- | -------------------------------- |
| 环境变量未加载 | `pnpm env:validate`              |
| 类型生成失败   | `node scripts/generate-api.js`   |
| 构建失败       | `pnpm clean:all && pnpm install` |
| 测试失败       | `node scripts/test-env.js`       |
| 代码检查失败   | `pnpm lint:fix`                  |

### 调试命令

```bash
# 启用调试模式
export DEBUG=true

# 查看监控日志
cat monitor-logs.json

# 分析构建性能
time pnpm build
```

## 📈 脚本优化建议

### 已完成优化 ✅

- ✅ 使用并行处理提高构建速度
- ✅ 实现增量构建减少重复工作
- ✅ 添加代码生成模板
- ✅ 实现智能错误修复建议
- ✅ 增加可视化监控界面

### 下一步优化计划

- 🔄 实现更智能的依赖管理
- 🔄 添加更多自动化测试场景
- 🔄 优化构建缓存策略
- 🔄 增强错误诊断能力

## 🎯 总结

通过交互式脚本管理器的实现，我们大幅简化了项目的使用复杂度：

- **脚本数量**: 从35个减少到11个 (减少68%)
- **命令记忆**: 只需要记住一个命令 `pnpm interactive`
- **用户体验**: 清晰的菜单和选项，带emoji图标
- **操作效率**: 循环操作，执行后自动返回菜单

### ✅ 已完成的核心功能

1. **完整的开发工具链** - ESLint、Prettier、Vitest、Husky
2. **交互式脚本管理器** - 统一的交互式界面
3. **类型生成系统** - 完整的TypeScript类型生成工具链
4. **环境管理系统** - 多环境配置和验证
5. **性能监控工具** - 构建、测试、安全监控
6. **备份回滚功能** - 版本管理和回滚机制
7. **文档系统** - VitePress文档站点

### 🎯 项目优势

- **现代化架构**: Vite + TypeScript
- **完整工具链**: 从开发到部署的全流程支持
- **交互式管理**: 大幅简化操作复杂度
- **类型安全**: 完整的TypeScript支持
- **自动化程度高**: 减少手动操作，提高效率
- **可扩展性强**: 易于添加新功能和包

这种设计让项目更加易用，同时保持了所有功能的完整性和灵活性。
